name: 'CES Validate'
description: 'Validate Claude Ecosystem Standard configuration and setup'
author: 'Claude Ecosystem Standard Team'

inputs:
  validation-level:
    description: 'Validation level (basic, full, enterprise)'
    required: false
    default: 'full'
  anthropic-check:
    description: 'Include Anthropic SDK validation'
    required: false
    default: 'true'
  config-file:
    description: 'Custom configuration file path'
    required: false
    default: '.env'
  fail-on-warnings:
    description: 'Fail validation on warnings'
    required: false
    default: 'false'

outputs:
  validation-status:
    description: 'Overall validation status'
    value: ${{ steps.validate.outputs.status }}
  issues-found:
    description: 'Number of issues found'
    value: ${{ steps.validate.outputs.issues }}
  anthropic-status:
    description: 'Anthropic SDK validation status'
    value: ${{ steps.anthropic.outputs.status }}
  config-status:
    description: 'Configuration validation status'
    value: ${{ steps.config.outputs.status }}

runs:
  using: 'composite'
  steps:
    - name: ðŸ” Setup Validation Environment
      shell: bash
      run: |
        echo "ðŸ” Setting up CES validation environment..."
        echo "Validation Level: ${{ inputs.validation-level }}"
        echo "Anthropic Check: ${{ inputs.anthropic-check }}"
        echo "Config File: ${{ inputs.config-file }}"

    - name: ðŸ“‹ Basic Project Structure Validation
      id: structure
      shell: bash
      run: |
        echo "ðŸ“‹ Validating CES project structure..."
        
        ISSUES=0
        
        # Required files
        REQUIRED_FILES=(
          "package.json"
          "tsconfig.json"
          "CLAUDE.md"
          "src/index.ts"
          "src/config/ConfigManager.ts"
          "src/cli/CLIManager.ts"
        )
        
        for file in "${REQUIRED_FILES[@]}"; do
          if [ ! -f "$file" ]; then
            echo "âŒ Missing required file: $file"
            ISSUES=$((ISSUES + 1))
          else
            echo "âœ… Found: $file"
          fi
        done
        
        # Required directories
        REQUIRED_DIRS=(
          "src/cli"
          "src/config"
          "src/session"
          "src/utils"
          "src/types"
          ".github"
          ".claude"
        )
        
        for dir in "${REQUIRED_DIRS[@]}"; do
          if [ ! -d "$dir" ]; then
            echo "âŒ Missing required directory: $dir"
            ISSUES=$((ISSUES + 1))
          else
            echo "âœ… Found: $dir"
          fi
        done
        
        echo "structure-issues=$ISSUES" >> $GITHUB_OUTPUT
        
        if [ $ISSUES -eq 0 ]; then
          echo "âœ… Project structure validation passed"
        else
          echo "âš ï¸ Project structure validation found $ISSUES issues"
        fi

    - name: âš™ï¸ Configuration Validation
      id: config
      shell: bash
      run: |
        echo "âš™ï¸ Validating CES configuration..."
        
        CONFIG_ISSUES=0
        
        # Check if config file exists
        if [ ! -f "${{ inputs.config-file }}" ]; then
          echo "âš ï¸ Configuration file not found: ${{ inputs.config-file }}"
          echo "Creating minimal configuration for validation..."
          
          cat > "${{ inputs.config-file }}" << EOF
          NODE_ENV=development
          CES_VERSION=2.7.0
          CES_PROJECT_NAME=claude-ecosystem-standard
          EOF
        fi
        
        # Load and validate configuration
        if [ -f "${{ inputs.config-file }}" ]; then
          echo "ðŸ“‹ Found configuration file: ${{ inputs.config-file }}"
          
          # Check required environment variables
          REQUIRED_VARS=(
            "NODE_ENV"
            "CES_VERSION"
            "CES_PROJECT_NAME"
          )
          
          for var in "${REQUIRED_VARS[@]}"; do
            if grep -q "^$var=" "${{ inputs.config-file }}"; then
              VALUE=$(grep "^$var=" "${{ inputs.config-file }}" | cut -d'=' -f2-)
              echo "âœ… $var=$VALUE"
            else
              echo "âš ï¸ Missing configuration: $var"
              CONFIG_ISSUES=$((CONFIG_ISSUES + 1))
            fi
          done
          
          # Check version consistency
          if [ -f "package.json" ]; then
            PACKAGE_VERSION=$(node -p "require('./package.json').version" 2>/dev/null || echo "unknown")
            CONFIG_VERSION=$(grep "^CES_VERSION=" "${{ inputs.config-file }}" | cut -d'=' -f2 | tr -d '"' || echo "unknown")
            
            if [ "$PACKAGE_VERSION" != "unknown" ] && [ "$CONFIG_VERSION" != "unknown" ]; then
              if [ "v$PACKAGE_VERSION" = "$CONFIG_VERSION" ] || [ "$PACKAGE_VERSION" = "$CONFIG_VERSION" ]; then
                echo "âœ… Version consistency: $PACKAGE_VERSION"
              else
                echo "âš ï¸ Version mismatch: package.json($PACKAGE_VERSION) vs config($CONFIG_VERSION)"
                CONFIG_ISSUES=$((CONFIG_ISSUES + 1))
              fi
            fi
          fi
        fi
        
        echo "config-issues=$CONFIG_ISSUES" >> $GITHUB_OUTPUT
        
        if [ $CONFIG_ISSUES -eq 0 ]; then
          echo "status=passed" >> $GITHUB_OUTPUT
          echo "âœ… Configuration validation passed"
        else
          echo "status=failed" >> $GITHUB_OUTPUT
          echo "âš ï¸ Configuration validation found $CONFIG_ISSUES issues"
        fi

    - name: ðŸ¤– Anthropic SDK Validation
      id: anthropic
      if: inputs.anthropic-check == 'true'
      shell: bash
      run: |
        echo "ðŸ¤– Validating Anthropic SDK integration..."
        
        ANTHROPIC_ISSUES=0
        
        # Check if Anthropic SDK is installed
        if [ -f "package.json" ]; then
          if grep -q "@anthropic-ai/sdk" package.json; then
            echo "âœ… Anthropic SDK dependency found"
            
            # Check SDK version
            SDK_VERSION=$(node -p "require('./package.json').dependencies['@anthropic-ai/sdk']" 2>/dev/null || echo "unknown")
            echo "ðŸ“¦ Anthropic SDK version: $SDK_VERSION"
          else
            echo "âš ï¸ Anthropic SDK not found in dependencies"
            ANTHROPIC_ISSUES=$((ANTHROPIC_ISSUES + 1))
          fi
        fi
        
        # Check for Anthropic integration files
        ANTHROPIC_FILES=(
          "src/integrations/anthropic/AnthropicSDKManager.ts"
          "src/cli/AnthropicCLI.ts"
        )
        
        for file in "${ANTHROPIC_FILES[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… Found Anthropic file: $file"
          else
            echo "âš ï¸ Missing Anthropic file: $file"
            ANTHROPIC_ISSUES=$((ANTHROPIC_ISSUES + 1))
          fi
        done
        
        # Check API key configuration (without exposing it)
        if grep -q "ANTHROPIC_API_KEY" "${{ inputs.config-file }}" 2>/dev/null; then
          echo "âœ… Anthropic API key configuration found"
        else
          echo "âš ï¸ Anthropic API key not configured"
          ANTHROPIC_ISSUES=$((ANTHROPIC_ISSUES + 1))
        fi
        
        echo "anthropic-issues=$ANTHROPIC_ISSUES" >> $GITHUB_OUTPUT
        
        if [ $ANTHROPIC_ISSUES -eq 0 ]; then
          echo "status=passed" >> $GITHUB_OUTPUT
          echo "âœ… Anthropic SDK validation passed"
        else
          echo "status=failed" >> $GITHUB_OUTPUT
          echo "âš ï¸ Anthropic SDK validation found $ANTHROPIC_ISSUES issues"
        fi

    - name: ðŸ”§ TypeScript Validation
      id: typescript
      shell: bash
      run: |
        echo "ðŸ”§ Validating TypeScript configuration..."
        
        TS_ISSUES=0
        
        # Check TypeScript configuration
        if [ -f "tsconfig.json" ]; then
          echo "âœ… Found tsconfig.json"
          
          # Validate TypeScript config syntax
          if node -e "JSON.parse(require('fs').readFileSync('tsconfig.json'))" 2>/dev/null; then
            echo "âœ… TypeScript configuration is valid JSON"
          else
            echo "âŒ TypeScript configuration has invalid JSON"
            TS_ISSUES=$((TS_ISSUES + 1))
          fi
          
          # Check for strict mode
          if grep -q '"strict": true' tsconfig.json; then
            echo "âœ… TypeScript strict mode enabled"
          else
            echo "âš ï¸ TypeScript strict mode not enabled"
            TS_ISSUES=$((TS_ISSUES + 1))
          fi
        else
          echo "âŒ Missing tsconfig.json"
          TS_ISSUES=$((TS_ISSUES + 1))
        fi
        
        echo "typescript-issues=$TS_ISSUES" >> $GITHUB_OUTPUT
        
        if [ $TS_ISSUES -eq 0 ]; then
          echo "âœ… TypeScript validation passed"
        else
          echo "âš ï¸ TypeScript validation found $TS_ISSUES issues"
        fi

    - name: ðŸ“¦ Dependencies Validation
      id: dependencies
      shell: bash
      run: |
        echo "ðŸ“¦ Validating project dependencies..."
        
        DEP_ISSUES=0
        
        # Check package.json
        if [ -f "package.json" ]; then
          echo "âœ… Found package.json"
          
          # Check for package-lock.json
          if [ -f "package-lock.json" ]; then
            echo "âœ… Found package-lock.json"
          else
            echo "âš ï¸ Missing package-lock.json"
            DEP_ISSUES=$((DEP_ISSUES + 1))
          fi
          
          # Check essential scripts
          REQUIRED_SCRIPTS=("build" "test" "lint" "dev")
          for script in "${REQUIRED_SCRIPTS[@]}"; do
            if node -p "require('./package.json').scripts['$script']" >/dev/null 2>&1; then
              echo "âœ… Found script: $script"
            else
              echo "âš ï¸ Missing script: $script"
              DEP_ISSUES=$((DEP_ISSUES + 1))
            fi
          done
          
          # Check for security vulnerabilities (if npm is available)
          if command -v npm >/dev/null 2>&1; then
            echo "ðŸ” Checking for security vulnerabilities..."
            if npm audit --audit-level=high >/dev/null 2>&1; then
              echo "âœ… No high-severity vulnerabilities found"
            else
              echo "âš ï¸ Security vulnerabilities detected"
              DEP_ISSUES=$((DEP_ISSUES + 1))
            fi
          fi
        else
          echo "âŒ Missing package.json"
          DEP_ISSUES=$((DEP_ISSUES + 1))
        fi
        
        echo "dependencies-issues=$DEP_ISSUES" >> $GITHUB_OUTPUT
        
        if [ $DEP_ISSUES -eq 0 ]; then
          echo "âœ… Dependencies validation passed"
        else
          echo "âš ï¸ Dependencies validation found $DEP_ISSUES issues"
        fi

    - name: ðŸ“Š Generate Validation Summary
      id: validate
      shell: bash
      run: |
        STRUCTURE_ISSUES="${{ steps.structure.outputs.structure-issues || '0' }}"
        CONFIG_ISSUES="${{ steps.config.outputs.config-issues || '0' }}"
        ANTHROPIC_ISSUES="${{ steps.anthropic.outputs.anthropic-issues || '0' }}"
        TS_ISSUES="${{ steps.typescript.outputs.typescript-issues || '0' }}"
        DEP_ISSUES="${{ steps.dependencies.outputs.dependencies-issues || '0' }}"
        
        TOTAL_ISSUES=$((STRUCTURE_ISSUES + CONFIG_ISSUES + ANTHROPIC_ISSUES + TS_ISSUES + DEP_ISSUES))
        
        echo "issues=$TOTAL_ISSUES" >> $GITHUB_OUTPUT
        
        # Determine overall status
        if [ $TOTAL_ISSUES -eq 0 ]; then
          echo "status=passed" >> $GITHUB_OUTPUT
          echo "âœ… All CES validations passed!"
        elif [ "${{ inputs.fail-on-warnings }}" = "true" ]; then
          echo "status=failed" >> $GITHUB_OUTPUT
          echo "âŒ CES validation failed with $TOTAL_ISSUES issues"
        else
          echo "status=passed-with-warnings" >> $GITHUB_OUTPUT
          echo "âš ï¸ CES validation passed with $TOTAL_ISSUES warnings"
        fi
        
        # Generate summary
        echo "## ðŸ” CES Validation Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Overall Status:** $([ $TOTAL_ISSUES -eq 0 ] && echo "âœ… PASSED" || echo "âš ï¸ WARNINGS")" >> $GITHUB_STEP_SUMMARY
        echo "- **Total Issues:** $TOTAL_ISSUES" >> $GITHUB_STEP_SUMMARY
        echo "- **Structure Issues:** $STRUCTURE_ISSUES" >> $GITHUB_STEP_SUMMARY
        echo "- **Configuration Issues:** $CONFIG_ISSUES" >> $GITHUB_STEP_SUMMARY
        echo "- **Anthropic Issues:** $ANTHROPIC_ISSUES" >> $GITHUB_STEP_SUMMARY
        echo "- **TypeScript Issues:** $TS_ISSUES" >> $GITHUB_STEP_SUMMARY
        echo "- **Dependencies Issues:** $DEP_ISSUES" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Validation Level:** ${{ inputs.validation-level }}" >> $GITHUB_STEP_SUMMARY
        echo "**Anthropic Check:** ${{ inputs.anthropic-check }}" >> $GITHUB_STEP_SUMMARY

branding:
  icon: 'check-circle'
  color: 'green'